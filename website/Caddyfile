{
    auto_https off
    admin off
    order rate_limit before basicauth
}

:{$PORT}

rate_limit {
    zone static_limit {
        key {remote_host}
        events 100
        window 1m
    }
}

header {
    X-Frame-Options "DENY"
    X-Content-Type-Options "nosniff"
    Referrer-Policy "strict-origin-when-cross-origin"
}

handle /api/orchestrator/* {
    rate_limit {
        zone orchestrator_limit {
            key {remote_host}
            events 300
            window 1m
        }
    }
    uri strip_prefix /api/orchestrator
    reverse_proxy https://orchestrator.rhinestone.dev {
        header_up X-Api-Key {$RHINESTONE_API_KEY}
        header_up Host orchestrator.rhinestone.dev
        header_down -Server
    }
}

handle /api/sql* {
    rate_limit {
        zone api_limit {
            key {remote_host}
            events 60
            window 1m
        }
    }
    header Access-Control-Allow-Origin "*"
    header Access-Control-Allow-Methods "GET, POST, OPTIONS"
    header Access-Control-Allow-Headers "Content-Type"
    
    uri strip_prefix /api
    reverse_proxy https://5jlt2hi0lte0h8n5pegrtoh72g.ingress.akash-palmito.org {
        header_up Host {upstream_hostport}
        transport http {
            tls_insecure_skip_verify
        }
    }
}

handle {
    root * /srv/website/dist
    
    @sw {
        path /service-worker.js
    }
    handle @sw {
        header Cache-Control "no-cache, no-store, must-revalidate"
        file_server
    }
    
    @static {
        path /assets/*
    }
    handle @static {
        header Cache-Control "public, max-age=31536000, immutable"
        file_server
    }
    
    @files {
        path *.js *.css *.json *.png *.jpg *.svg *.woff2 *.ico *.webmanifest
    }
    handle @files {
        header Cache-Control "public, max-age=3600"
        file_server
    }
    
    handle {
        try_files {path} /index.html
        file_server
    }
}