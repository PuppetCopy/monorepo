{
    auto_https off
    admin off
}

:{$PORT}

# Global security headers
header {
    X-Frame-Options "DENY"
    X-Content-Type-Options "nosniff"
    X-XSS-Protection "1; mode=block"
    Referrer-Policy "strict-origin-when-cross-origin"
    Permissions-Policy "geolocation=(), microphone=(), camera=()"
}

# Simple proxy to indexer API (via our subdomain)
handle /api/sql* {
    # CORS headers
    header Access-Control-Allow-Origin "https://puppet.tech"
    header Access-Control-Allow-Methods "GET, POST, OPTIONS"
    
    # Strip /api prefix and proxy to indexer's root path
    uri strip_prefix /api
    reverse_proxy http://indexer:42069 {
        header_up Host {upstream_hostport}
    }
}

handle /api/orchestrator/* {
    uri strip_prefix /api/orchestrator
    reverse_proxy https://orchestrator.rhinestone.dev {
        header_up X-Api-Key {$RHINESTONE_API_KEY}
        header_up Host orchestrator.rhinestone.dev
        header_down -Server
    }
}

handle {
    root * /srv/website/dist
    try_files {path} /index.html
    file_server {
        precompressed gzip br
    }
    
    @static {
        path /assets/* *.js *.css *.woff2
    }
    header @static Cache-Control "public, max-age=31536000, immutable"
    
    @sw {
        path /sw.js /service-worker.js
    }
    header @sw Cache-Control "no-cache, no-store, must-revalidate"
}