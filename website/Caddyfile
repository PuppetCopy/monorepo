{
    auto_https off
    admin off
}

:{$PORT}

# Global security headers
header {
    X-Frame-Options "DENY"
    X-Content-Type-Options "nosniff"
    X-XSS-Protection "1; mode=block"
    Referrer-Policy "strict-origin-when-cross-origin"
    Permissions-Policy "geolocation=(), microphone=(), camera=()"
    Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
}

# Indexer API proxy (/api/indexer/* â†’ /*)
handle /api/indexer/* {
    header Access-Control-Allow-Origin "https://puppet.tech"
    header Access-Control-Allow-Methods "GET, OPTIONS"
    header Access-Control-Allow-Headers "Content-Type"

    @options method OPTIONS
    respond @options 204

    @notFromSite {
        not header Referer https://puppet.tech*
        not header Referer https://www.puppet.tech*
    }
    respond @notFromSite "Forbidden" 403

    uri strip_prefix /api/indexer
    reverse_proxy {$INDEXER_ENDPOINT} {
        header_up Host {upstream_hostport}
        transport http {
            tls_insecure_skip_verify
            read_timeout 120s
            write_timeout 120s
        }
    }
}

handle /api/status {
    header Access-Control-Allow-Origin "*"
    rewrite * /status
    reverse_proxy {$INDEXER_URL} {
        header_up Host {upstream_hostport}
        transport http {
            tls_insecure_skip_verify
        }
    }
}

handle /api/rpc {
    @notFromSite {
        not header Referer https://puppet.tech*
        not header Referer https://www.puppet.tech*
    }
    respond @notFromSite "Forbidden" 403

    rewrite * /{query.network}/{$RPC_KEY}
    reverse_proxy {$RPC_URL} {
        header_up Host {upstream_hostport}
    }
}

# Health check endpoint
handle /health {
    respond "OK" 200
}

handle {
    root * /srv/website/dist
    encode gzip

    # Serve static files first with proper caching
    @static {
        path /assets/*
    }
    handle @static {
        header Cache-Control "public, max-age=31536000, immutable"
        file_server {
            precompressed gzip br
        }
    }

    # Service worker - must always check for updates
    @sw {
        path /service-worker.js
    }
    handle @sw {
        header Cache-Control "no-cache, no-store, must-revalidate"
        file_server
    }

    # Manifest and root-level files (favicon, robots.txt, etc)
    @rootfiles {
        path *.webmanifest *.ico *.txt *.xml
    }
    handle @rootfiles {
        header Cache-Control "public, max-age=3600"
        file_server
    }

    # SPA fallback - ONLY for actual routes, not files
    handle {
        try_files {path} /index.html
        file_server
    }
}
